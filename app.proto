syntax = "proto3";

package agnt;

// Bidirectional streaming service
service AgntService {
    rpc Connect(stream AgentMessage) returns (stream ServerMessage);
}


// DJANGO / CLIENT SERVICE
service ClientService {
    rpc SendCommand (CommandRequest) returns (CommandResponse);
}

// Messages sent from Agent → Server
message AgentMessage {
    string agent_id = 1;       // sent once on initial connection
    string heartbeat = 2;      // sent periodically to keep connection alive
    TableList table_names = 3;      // list of table names (query result)
    string message = 4;        // optional: query result as string or error messages
    QueryResult query_result = 5; 
    string worker_id = 6;
}


// Messages sent from Server → Agent
message ServerMessage {
    string database = 1;       // database type: "postgres", "mysql", etc.
    string query = 2;          // SQL query to execute
    string request_id = 3;   // unique ID assigned by server
    string tbl_name = 4;
    DatabaseConfig db_config = 5;

}

message DatabaseConfig {
    oneof config {
        SqlServerConfig sqlserver = 1;
        OracleConfig oracle = 2;
    }
}

/* ---------- SQL SERVER ---------- */
message SqlServerConfig {
    string host = 1;
    string port = 2;
    string db_name = 3;
    string schema = 4;
    string user = 5;
    string password = 6;
}

/* ---------- ORACLE ---------- */
message OracleConfig {
    string user = 1;
    string password = 2;
    string host = 3;
    string port =4;             // ezconnect / tns alias
    bool use_wallet = 5;     // optional
    string service_name = 6;
    string schema = 7;
    string dsn = 8; //used only in case of connecting with wallet
}


// Used when query result is a list of table names
message TableList {
    repeated string names = 1;
}

message QueryResult {
    string json = 1;
    string request_id = 2;    // echo back the same ID from ServerMessage
    string tbl_meta_data = 3;
}


// ---------- Django → Server ----------
message CommandRequest {
    string agent_id = 1;
    string database = 2;
    string query = 3;
    string tbl_name = 4;
    DatabaseConfig db_config = 5;
}

// ---------- Server → Django ----------
message CommandResponse {
    string json = 1;
    string message = 2;
    string meta_data = 3;
}